---
title: "Analysis of U.S. Storm Damage Loss"
author: "Chen Xing"
date: "3/23/2022"
output: html_document
---

## Abstract


## Data Processing
### 1. Load Packages
The R package `Tidyverse` is main tool in this analysis.
```{r, package, message=FALSE}
require(tidyverse)
require(lubridate)
require(ggpubr)
```
### 2. Load the data
Thanks to the use of tidyverse, we can directly load the data downloaded from assignment website without unzipping it.   
And we can load event name list information from "Storm Data Documentation" pdf file.
```{r, load data, message=FALSE}
dt <- read_csv("repdata-data-StormData.csv.bz2")
eventlist <- read_csv("even_list.csv") %>% mutate(EVTYPE=toupper(EVTYPE))
```
### 3. Select the Data
We select the data we need to find the answers to these two questions, and group the data by severe weather types.
```{r, filter data}
dt_1 <- dt %>% select(BGN_DATE, BGN_TIME, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP,CROPDMG, CROPDMGEXP) %>% mutate(EVTYPE=toupper(EVTYPE)) %>%
  filter(EVTYPE %in% eventlist$EVTYPE) %>%
  mutate(BGN_DATE=mdy_hms(BGN_DATE)) %>%
  group_by(EVTYPE)

head(dt_1)
```
### 4. Casualty Statistics
Calculate the total and average number of fatalities and injuries between `evtype`.
```{r, fatalities and injuries}
dt_fj <- dt_1 %>% mutate(fj=FATALITIES+INJURIES) %>%
  summarise(sumfj=sum(fj), meanfj=mean(fj,na.rm=T),sumi=sum(INJURIES), meani=mean(INJURIES,na.rm=T),
            sumf=sum(FATALITIES), meanf=mean(FATALITIES, na.rm=T)) %>%
  arrange(-sumfj)

head(dt_fj)
```
### 5. Economic loss
Calculate the total and average economic consequences between `evtype`.
```{r, eco loss}
dt_eco <- dt_1 %>% rowwise() %>%
  mutate_at(c("PROPDMGEXP","CROPDMGEXP"), ~ if (is.na(.x)) {1}
                             else if(.x=="K"){1000}else if(.x=="M"){1000000
                               }else if(.x=="B"){1000000000}else 1) %>%
  mutate(DMG_ALL=PROPDMG*PROPDMGEXP+CROPDMG*CROPDMGEXP) %>%
  ungroup() %>% group_by(EVTYPE) %>%
  summarise(sum_ecodmg=sum(DMG_ALL), mean_ecodmg=mean(DMG_ALL,na.rm=T)) %>%
  arrange(-sum_ecodmg)
  
head(dt_eco)
```
### 6. Merge Data
```{r, merge}
dt_tidy <- left_join(dt_fj, dt_eco)
```
## Results
### 1. Across the United States, which types of events (as indicated in the `EVTYPE` variable) are most **harmful** with respect to population **health**?

```{r, q1}
# Calculate the 99% percentile for each variable.
quan <- dt_tidy %>% summarise(across(where(is.numeric),~ quantile(.x,0.8)))

p_sfj <- filter(dt_tidy, sumfj>quan$sumfj) %>%
  mutate(EVTYPE = fct_reorder(EVTYPE, -sumfj)) %>%
  ggplot(aes(EVTYPE,sumfj/1000)) + geom_col(fill="orange") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size=7,face="bold")) +
  labs(x = NULL, y = "Total(Thousands)")


p_mfj <- filter(dt_tidy, meanfj>quan$meanfj) %>%
  mutate(EVTYPE = fct_reorder(EVTYPE, -meanfj)) %>%
  ggplot(aes(EVTYPE,meanfj)) + geom_col(fill="orange") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size=7,face="bold")) +
  labs(x = NULL, y = "Average")


p_sf <- filter(dt_tidy, sumf>quan$sumf) %>%
  mutate(EVTYPE = fct_reorder(EVTYPE, -sumf)) %>%
  ggplot(aes(EVTYPE,sumf/1000)) + geom_col(fill="red") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size=7,face="bold")) +
  labs(x = NULL, y = "Total(Thousands)")


p_mf <- filter(dt_tidy, meanf>quan$meanf) %>%
  mutate(EVTYPE = fct_reorder(EVTYPE, -meanf)) %>%
  ggplot(aes(EVTYPE,meanf)) + geom_col(fill="red") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, vjust = 1, size=7,face="bold")) +
  labs(x = NULL, y = "Average")

ggarrange(p_sfj, p_mfj,p_sf, p_mf,labels = c("A", "B", "C", "D"), ncol = 2, nrow = 2)
```


